name: Build Maui.RevenueCat.InAppBilling for publishing to nuget

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_NUMBER: '4.6'

jobs:
  build:

    runs-on: windows-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
    
    - name: Setup .NET framework
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Install required .NET workloads
      run: dotnet workload install maui --ignore-failed-sources

    - name: Restore nuget dependencies
      run: dotnet restore src/Maui.RevenueCat.InAppBilling.sln
      
    - name: Build Maui.RevenueCat.InAppBilling solution
      run: dotnet build src/Maui.RevenueCat.InAppBilling.sln -c Release -p:Version=${{ env.BUILD_NUMBER }}.${{ github.run_number }} --no-restore 

    - name: Creat Maui.RevenueCat.InAppBilling nuget package
      run: dotnet pack src/Maui.RevenueCat.InAppBilling/Maui.RevenueCat.csproj --configuration Release -p:Version=${{ env.BUILD_NUMBER }}.${{ github.run_number }} --output .

    - name: Archive Maui.RevenueCat.InAppBilling nuget package
      uses: thedoctor0/zip-release@0.7.5
      with:
        type: 'zip'
        path: 'src/Maui.RevenueCat.InAppBilling/bin/release/*.nupkg'
        filename: 'maui.revenuecat.inappbilling_${{ env.BUILD_NUMBER }}.${{ github.run_number }}.zip'
        exclusions: '*.git* /*node_modules/* .editorconfig'

    - name: Upload archive to releases
      uses: ncipollo/release-action@v1.12.0
      with:
        artifacts: 'maui.revenuecat.inappbilling_${{ env.BUILD_NUMBER }}.${{ github.run_number }}.zip'
        tag: ${{ env.BUILD_NUMBER }}.${{ github.run_number }}

      # Publish all NuGet packages to NuGet.org
      # Use --skip-duplicate to prevent errors if a package with the same version already exists.
      # If you retry a failed workflow, already published packages will be skipped without error.
    - name: Push Maui.RevenueCat.InAppBilling to nuget.org
      run: |
        foreach($file in (Get-ChildItem "src/Maui.RevenueCat.InAppBilling/bin/release/" -Recurse -Include *.nupkg)) {
            dotnet nuget push $file --api-key "${{ secrets.NUGET_APIKEY }}" --source https://api.nuget.org/v3/index.json --skip-duplicate
        }
